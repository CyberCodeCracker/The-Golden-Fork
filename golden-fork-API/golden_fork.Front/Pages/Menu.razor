@page "/menu"
@attribute [Authorize]
@using golden_fork.Front
@using golden_fork.Front.DTOs.Kitchen
@using System.Text.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Menu • Golden Fork</PageTitle>

<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-bold text-orange-600">Our Menus</h1>
        @if (IsAdminOrChef)
        {
            <button @onclick="OpenAddModal" class="btn btn-primary">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add New Menu
            </button>
        }
    </div>

    @if (isLoading)
    {
        <div class="flex justify-center py-20">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    }
    else if (!menus.Any())
    {
        <div class="text-center py-20">
            <p class="text-2xl text-gray-500">No menus available yet.</p>
        </div>
    }
    else
    {
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            @foreach (var menu in menus)
            {
                <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow">
                    <div class="card-body">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="card-title text-2xl text-orange-600">@menu.Name</h2>
                                <p class="text-gray-600 mt-2">@menu.Description</p>
                                <p class="text-sm text-gray-500 mt-4">
                                    @menu.ItemCount item@(menu.ItemCount == 1 ? "" : "s")
                                </p>
                            </div>
                            @if (IsAdminOrChef)
                            {
                                <div class="dropdown dropdown-end">
                                    <label tabindex="0" class="btn btn-ghost btn-circle">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                        </svg>
                                    </label>
                                    <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                                        <li><a @onclick="() => OpenEditModal(menu)">Edit</a></li>
                                        <li><a @onclick="() => DeleteMenu(menu.Id)" class="text-red-600">Delete</a></li>
                                    </ul>
                                </div>
                            }
                        </div>
                        <div class="card-actions mt-6">
                            <a href="/menu/@menu.Id" class="btn btn-outline btn-primary w-full">
                                View Menu
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Add/Edit Modal -->
@if (showModal)
{
    <div class="modal modal-open">
        <div class="modal-box">
            <h3 class="font-bold text-2xl mb-6">@(isEdit ? "Edit Menu" : "Add New Menu")</h3>

            <EditForm Model="menuModel" OnValidSubmit="HandleSave">
                <DataAnnotationsValidator />

                @if (!string.IsNullOrEmpty(ModalMessage))
                {
                    <div class="alert @(ModalSuccess ? "alert-success" : "alert-error") mb-4">
                        <span>@ModalMessage</span>
                    </div>
                }

                <div class="space-y-4">
                    <div>
                        <label class="label"><span class="label-text">Name</span></label>
                        <InputText @bind-Value="menuModel.Name" class="input input-bordered w-full" />
                        <ValidationMessage For="() => menuModel.Name" />
                    </div>

                    <div>
                        <label class="label"><span class="label-text">Description</span></label>
                        <InputTextArea @bind-Value="menuModel.Description" class="textarea textarea-bordered w-full" rows="4" />
                    </div>
                </div>

                <div class="modal-action">
                    <button type="submit" class="btn btn-primary" disabled="@modalLoading">
                        @if (modalLoading)
                        {
                            <span class="loading loading-spinner"></span>
                        }
                        Save
                    </button>
                    <button type="button" @onclick="CloseModal" class="btn">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private List<MenuCardResponse> menus = new();
    private bool isLoading = true;
    private bool IsAdminOrChef = false;

    // Modal
    private bool showModal = false;
    private bool isEdit = false;
    private MenuRequest menuModel = new();
    private int? editingId;
    private string ModalMessage = "";
    private bool ModalSuccess = false;
    private bool modalLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadMenus();
        await CheckRole();
    }

    private async Task LoadMenus()
    {
        isLoading = true;
        try
        {
            var response = await Http.GetFromJsonAsync<PagedResult<MenuCardResponse>>("api/menu");
            menus = response?.Items?.ToList() ?? new();
        }
        catch
        {
            // handle error
        }
        isLoading = false;
    }

    private async Task CheckRole()
    {
        // Simple way: try to call an admin endpoint
        var response = await Http.GetAsync("api/user/debug/userinfo");
        if (response.IsSuccessStatusCode)
        {
            var info = await response.Content.ReadFromJsonAsync<JsonElement>();
            var role = info.GetProperty("role").GetString();
            IsAdminOrChef = role == "Admin" || role == "Chef";
        }
    }

    private void OpenAddModal()
    {
        isEdit = false;
        editingId = null;
        menuModel = new MenuRequest();
        ModalMessage = "";
        showModal = true;
    }

    private void OpenEditModal(MenuCardResponse menu)
    {
        isEdit = true;
        editingId = menu.Id;
        menuModel = new MenuRequest
        {
            Name = menu.Name,
            Description = menu.Description
        };
        ModalMessage = "";
        showModal = true;
    }

    private async Task HandleSave()
    {
        modalLoading = true;
        ModalMessage = "";

        try
        {
            HttpResponseMessage response;
            if (isEdit)
            {
                response = await Http.PutAsJsonAsync($"api/menu/{editingId}", menuModel);
            }
            else
            {
                response = await Http.PostAsJsonAsync("api/menu", menuModel);
            }

            if (response.IsSuccessStatusCode)
            {
                ModalSuccess = true;
                ModalMessage = isEdit ? "Menu updated!" : "Menu created!";
                await Task.Delay(1500);
                CloseModal();
                await LoadMenus();
            }
            else
            {
                ModalSuccess = false;
                ModalMessage = "Failed to save menu";
            }
        }
        catch
        {
            ModalSuccess = false;
            ModalMessage = "Network error";
        }

        modalLoading = false;
    }

    private async Task DeleteMenu(int id)
    {
        var confirm = await JS.InvokeAsync<bool>("confirm", "Delete this menu?");
        if (!confirm) return;

        var response = await Http.DeleteAsync($"api/menu/{id}");
        if (response.IsSuccessStatusCode)
        {
            await LoadMenus();
        }
    }

    private void CloseModal()
    {
        showModal = false;
    }
}