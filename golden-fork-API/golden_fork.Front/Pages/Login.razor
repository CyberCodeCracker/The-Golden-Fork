@layout PublicLayout  
@page "/login"
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using GoldenFork.Frontend.Services
@using Microsoft.AspNetCore.Components.Authorization
@using System.Net.Http.Headers
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Login • Golden Fork</PageTitle>

<div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center p-4">
    <div class="w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-orange-600 mb-2">Golden Fork</h1>
                <p class="text-gray-600">Welcome back! Please login</p>
            </div>

            @if (!string.IsNullOrEmpty(Message))
            {
                <div class="alert @AlertClass mb-6 shadow-lg">
                    <svg class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="@(IsSuccess ? "M5 13l4 4L19 7" : "M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z")" />
                    </svg>
                    <span>@Message</span>
                </div>
            }

            <EditForm Model="model" OnValidSubmit="HandleLogin">
                <DataAnnotationsValidator />

                <div class="space-y-5">
                    <div>
                        <label class="label"><span class="label-text">Email</span></label>
                        <InputText @bind-Value="model.Email" class="input input-bordered w-full" placeholder="john@example.com" />
                        <ValidationMessage For="() => model.Email" class="text-red-500 text-sm mt-1" />
                    </div>

                    <div>
                        <label class="label"><span class="label-text">Password</span></label>
                        <InputText @bind-Value="model.Password" type="password" class="input input-bordered w-full" placeholder="••••••••" />
                        <ValidationMessage For="() => model.Password" class="text-red-500 text-sm mt-1" />
                    </div>
                </div>

                <button type="submit" disabled="@isLoading" class="btn btn-primary w-full mt-8">
                    @if (isLoading)
                    {
                        <span class="loading loading-spinner mr-2"></span>
                        <span>Logging in...</span>
                    }
                    else
                    {
                        <span>Login</span>
                    }
                </button>
            </EditForm>

            <div class="text-center mt-6">
                <p class="text-sm text-gray-600">
                    Don't have an account?
                    <a href="/register" class="link link-primary font-semibold">Register here</a>
                </p>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginModel model = new();
    private string Message = "";
    private string AlertClass => IsSuccess ? "alert-success" : "alert-error";
    private bool isLoading = false;
    private bool IsSuccess = false;

    private class LoginModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email format")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Password is required")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters")]
        public string Password { get; set; } = "";
    }

    private async Task HandleLogin()
    {
        isLoading = true;
        Message = "";
        IsSuccess = false;
        StateHasChanged();

        try
        {
            var response = await Http.PostAsJsonAsync("api/user/login", new
            {
                Email = model.Email.Trim(),
                Password = model.Password
            });

            if (response.IsSuccessStatusCode)
            {
                var data = await response.Content.ReadFromJsonAsync<JsonElement>();
                var token = data.GetProperty("token").GetString();

                // Store token
                await JS.InvokeVoidAsync("localStorage.setItem", "jwtToken", token);


                // Notify Blazor that user is authenticated
                var authProvider = (CustomAuthenticationStateProvider)AuthStateProvider;
                authProvider.NotifyUserAuthentication();

                Navigation.NavigateTo("/menu", true);
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Message = errorContent.Contains("message")
                    ? JsonSerializer.Deserialize<JsonElement>(errorContent).GetProperty("message").GetString()
                    : "Invalid email or password";
                IsSuccess = false;
            }
        }
        catch (Exception)
        {
            Message = "Network error. Please try again later.";
            IsSuccess = false;
        }

        isLoading = false;
        StateHasChanged();
    }
}