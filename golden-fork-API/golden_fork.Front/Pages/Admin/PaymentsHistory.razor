@page "/admin/payments"
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Order History • Golden Fork</PageTitle>

<div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-orange-600 mb-8">Order History</h1>
    
    <!-- Filters -->
    <div class="flex flex-wrap gap-4 mb-6">
        <select class="select select-bordered" @bind="selectedStatus">
            <option value="">All Statuses</option>
            <option value="Pending">Pending</option>
            <option value="Processing">Processing</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
        </select>
        
        <input type="date" class="input input-bordered" @bind="startDate" />
        <input type="date" class="input input-bordered" @bind="endDate" />
        
        <button @onclick="LoadOrders" class="btn btn-primary">Apply Filters</button>
        <button @onclick="ClearFilters" class="btn btn-ghost">Clear</button>
    </div>
    
    @if (isLoading)
    {
        <div class="flex justify-center py-20">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    }
    else if (orders == null || !orders.Any())
    {
        <div class="text-center py-20">
            <p class="text-2xl text-gray-500">No orders found</p>
        </div>
    }
    else
    {
        <div class="space-y-6">
            @foreach (var order in orders)
            {
                <div class="card bg-base-100 shadow-lg">
                    <div class="card-body">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="card-title">Order #@order.Id</h2>
                                <p class="text-gray-600">
                                    Customer: <strong>@order.CustomerName</strong> (@order.CustomerEmail)
                                </p>
                                <p class="text-gray-600">
                                    Date: @order.OrderDate.ToString("f")
                                </p>
                            </div>
                            
                            <div class="text-right">
                                <div class="text-2xl font-bold text-primary">
                                    @order.TotalAmount.ToString("C")
                                </div>
                                <div class="mt-2">
                                    <select class="select select-bordered select-sm" 
                                            @bind="order.NewStatus">
                                        <option value="">Change Status</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Processing">Processing</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Order Items -->
                        <div class="mt-4">
                            <h3 class="font-semibold mb-2">Order Items:</h3>
                            <div class="overflow-x-auto">
                                <table class="table table-zebra w-full">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in order.OrderItems)
                                        {
                                            <tr>
                                                <td>@item.ItemName</td>
                                                <td>@item.Quantity</td>
                                                <td>@item.UnitPrice.ToString("C")</td>
                                                <td>@((item.Quantity * item.UnitPrice).ToString("C"))</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Status and Actions -->
                        <div class="flex justify-between items-center mt-4 pt-4 border-t">
                            <div>
                                <span class="font-semibold">Current Status:</span>
                                <span class="badge @GetStatusBadgeClass(order.Status) ml-2">
                                    @order.Status
                                </span>
                            </div>
                            
                            <div class="flex gap-2">
                                @if (!string.IsNullOrEmpty(order.NewStatus) && order.NewStatus != order.Status)
                                {
                                    <button @onclick="() => UpdateOrderStatus(order.Id, order.NewStatus)" 
                                            class="btn btn-primary btn-sm">
                                        Update Status
                                    </button>
                                }
                                <button @onclick="() => ViewOrderDetails(order.Id)" 
                                        class="btn btn-info btn-sm">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <div class="flex justify-center mt-8 gap-2">
                <button @onclick="() => ChangePage(currentPage - 1)"
                        disabled="@(currentPage == 1)"
                        class="btn btn-outline">
                    Previous
                </button>
                
                @for (int i = 1; i <= totalPages; i++)
                {
                    <button @onclick="() => ChangePage(i)"
                            class="btn @(i == currentPage ? "btn-primary" : "btn-outline")">
                        @i
                    </button>
                }
                
                <button @onclick="() => ChangePage(currentPage + 1)"
                        disabled="@(currentPage == totalPages)"
                        class="btn btn-outline">
                    Next
                </button>
            </div>
        }
    }
</div>

@code {
    private List<OrderDto> orders = new();
    private bool isLoading = true;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private string selectedStatus = "";
    private DateTime? startDate = DateTime.Today.AddDays(-30);
    private DateTime? endDate = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var url = $"api/order/admin?page={currentPage}&pageSize={pageSize}";
            
            if (!string.IsNullOrEmpty(selectedStatus))
                url += $"&status={selectedStatus}";
            
            if (startDate.HasValue)
                url += $"&startDate={startDate.Value:yyyy-MM-dd}";
            
            if (endDate.HasValue)
                url += $"&endDate={endDate.Value:yyyy-MM-dd}";

            var response = await Http.GetFromJsonAsync<OrderListResponse>(url);
            
            if (response != null)
            {
                orders = response.Orders;
                totalPages = response.TotalPages;
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error loading orders: {ex.Message}");
        }

        isLoading = false;
        StateHasChanged();
    }

    private async Task UpdateOrderStatus(int orderId, string newStatus)
    {
        var confirm = await JS.InvokeAsync<bool>("confirm", 
            $"Change order status to {newStatus}?");
        
        if (!confirm) return;

        try
        {
            var updateRequest = new { OrderId = orderId, NewStatus = newStatus };
            var response = await Http.PutAsJsonAsync("api/order/update-status", updateRequest);
            
            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "Order status updated!");
                await LoadOrders(); // Refresh the list
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Failed: {error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private void ViewOrderDetails(int orderId)
    {
        // Navigate to order details page or show modal
        // For now, just show an alert
        JS.InvokeVoidAsync("alert", $"Viewing order #{orderId} details");
    }

    private void ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        LoadOrders();
    }

    private void ClearFilters()
    {
        selectedStatus = "";
        startDate = DateTime.Today.AddDays(-30);
        endDate = DateTime.Today;
        currentPage = 1;
        LoadOrders();
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Completed" => "badge-success",
            "Processing" => "badge-warning",
            "Pending" => "badge-info",
            "Cancelled" => "badge-error",
            _ => "badge-neutral"
        };
    }

    public class OrderDto
    {
        public int Id { get; set; }
        public string CustomerName { get; set; } = string.Empty;
        public string CustomerEmail { get; set; } = string.Empty;
        public DateTime OrderDate { get; set; }
        public decimal TotalAmount { get; set; }
        public string Status { get; set; } = string.Empty;
        public List<OrderItemDto> OrderItems { get; set; } = new();
        public string? NewStatus { get; set; }
    }

    public class OrderItemDto
    {
        public string ItemName { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public decimal UnitPrice { get; set; }
    }

    public class OrderListResponse
    {
        public List<OrderDto> Orders { get; set; } = new();
        public int TotalPages { get; set; }
    }
}