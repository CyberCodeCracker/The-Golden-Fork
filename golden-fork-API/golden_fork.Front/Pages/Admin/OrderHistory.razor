@page "/admin/order-history"
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject IJSRuntime JS
@using golden_fork.Front.DTOs.Order
@using golden_fork.Front.DTOs.Purchase
@using golden_fork.core.Enums

<PageTitle>Order History • Golden Fork</PageTitle>

<div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-orange-600 mb-8">Order History</h1>
    
    <!-- Filters -->
    <div class="flex flex-wrap gap-4 mb-6">
        <select class="select select-bordered" @bind="selectedStatusFilter">
            <option value="">All Statuses</option>
            <option value="Pending">Pending</option>
            <option value="Processing">Processing</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
        </select>
        
        <input type="date" class="input input-bordered" @bind="startDate" />
        <input type="date" class="input input-bordered" @bind="endDate" />
        
        <button @onclick="LoadOrders" class="btn btn-primary">Apply Filters</button>
        <button @onclick="ClearFilters" class="btn btn-ghost">Clear</button>
    </div>
    
    @if (isLoading)
    {
        <div class="flex justify-center py-20">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    }
    else if (orders == null || !orders.Any())
    {
        <div class="text-center py-20">
            <p class="text-2xl text-gray-500">No orders found</p>
        </div>
    }
    else
    {
        <div class="space-y-6">
            @foreach (var order in orders)
            {
                <div class="card bg-base-100 shadow-lg">
                    <div class="card-body">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="card-title">Order #@order.Id</h2>
                                <p class="text-gray-600">
                                    Customer: <strong>@order.UserName</strong>
                                </p>
                                <p class="text-gray-600">
                                    Date: @order.OrderDate.ToString("f")
                                </p>
                                <p class="text-gray-600">
                                    Items: @order.ItemCount
                                </p>
                            </div>
                            
                            <div class="text-right">
                                <div class="text-2xl font-bold text-primary">
                                    @order.TotalPrice.ToString("C")
                                </div>
                                <div class="mt-2">
                                    <select class="select select-bordered select-sm" 
                                            value="@selectedUpdateStatus"
                                            @onchange="@((ChangeEventArgs e) => OnStatusChange(order.Id, e.Value?.ToString()))">
                                        <option value="">Change Status</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Processing">Processing</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Order Items -->
                        <div class="mt-4">
                            <h3 class="font-semibold mb-2">Order Items:</h3>
                            <div class="overflow-x-auto">
                                <table class="table table-zebra w-full">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in order.Items)
                                        {
                                            <tr>
                                                <td>@item.ItemName</td>
                                                <td>@item.Quantity</td>
                                                <td>@item.UnitPrice.ToString("C")</td>
                                                <td>@item.LineTotal.ToString("C")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Status and Actions -->
                        <div class="flex justify-between items-center mt-4 pt-4 border-t">
                            <div>
                                <span class="font-semibold">Current Status:</span>
                                <span class="badge @GetStatusBadgeClass(order.Status.ToString()) ml-2">
                                    @order.Status
                                </span>
                            </div>
                            
                            <div class="flex gap-2">
                                @if (order.Id == selectedOrderId && 
                                     !string.IsNullOrEmpty(selectedUpdateStatus) && 
                                     selectedUpdateStatus != order.Status.ToString())
                                {
                                    <button @onclick="() => UpdateOrderStatus(order.Id, selectedUpdateStatus)" 
                                            class="btn btn-primary btn-sm">
                                        Update Status
                                    </button>
                                }
                                <button @onclick="() => ViewOrderDetails(order.Id)" 
                                        class="btn btn-info btn-sm">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <div class="flex justify-center mt-8 gap-2">
                <button @onclick="() => ChangePage(currentPage - 1)"
                        disabled="@(currentPage == 1)"
                        class="btn btn-outline">
                    Previous
                </button>
                
                @for (int i = 1; i <= totalPages; i++)
                {
                    <button @onclick="() => ChangePage(i)"
                            class="btn @(i == currentPage ? "btn-primary" : "btn-outline")">
                        @i
                    </button>
                }
                
                <button @onclick="() => ChangePage(currentPage + 1)"
                        disabled="@(currentPage == totalPages)"
                        class="btn btn-outline">
                    Next
                </button>
            </div>
        }
    }
</div>

@code {
    private List<OrderResponse> orders = new();
    private bool isLoading = true;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private string selectedStatusFilter = "";
    private DateTime? startDate = DateTime.Today.AddDays(-30);
    private DateTime? endDate = DateTime.Today;
    
    // For status updates
    private int? selectedOrderId = null;
    private string selectedUpdateStatus = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var url = $"api/order/admin?page={currentPage}&pageSize={pageSize}";
            
            if (!string.IsNullOrEmpty(selectedStatusFilter))
                url += $"&status={selectedStatusFilter}";
            
            if (startDate.HasValue)
                url += $"&startDate={startDate.Value:yyyy-MM-dd}";
            
            if (endDate.HasValue)
                url += $"&endDate={endDate.Value:yyyy-MM-dd}";

            var response = await Http.GetAsync(url);
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                
                var result = System.Text.Json.JsonSerializer.Deserialize<PagedResponse<OrderResponse>>(
                    content, 
                    new System.Text.Json.JsonSerializerOptions 
                    { 
                        PropertyNameCaseInsensitive = true 
                    });
                
                if (result != null)
                {
                    orders = result.Items ?? new List<OrderResponse>();
                    totalPages = result.TotalPages;
                }
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }

        isLoading = false;
        StateHasChanged();
    }

    private void OnStatusSelected(int orderId)
    {
        selectedOrderId = orderId;
        StateHasChanged();
    }

    private async Task UpdateOrderStatus(int orderId, string newStatusString)
    {
        var confirm = await JS.InvokeAsync<bool>("confirm", 
            $"Change order status to {newStatusString}?");
        
        if (!confirm) return;

        try
        {
            // Parse the string to OrderStatus enum
            if (Enum.TryParse<OrderStatus>(newStatusString, out var newStatus))
            {
                var updateRequest = new OrderUpdateRequest { Status = newStatus };
                var response = await Http.PutAsJsonAsync($"api/order/{orderId}/status", updateRequest);
                
                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "Order status updated!");
                    await LoadOrders(); // Refresh the list
                    
                    // Reset selection
                    selectedOrderId = null;
                    selectedUpdateStatus = "";
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    await JS.InvokeVoidAsync("alert", $"Failed: {error}");
                }
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"Invalid status: {newStatusString}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private void OnStatusChange(int orderId, string newStatus)
    {
        selectedOrderId = orderId;
        selectedUpdateStatus = newStatus;
        StateHasChanged();
    }

    private void ViewOrderDetails(int orderId)
    {
        JS.InvokeVoidAsync("alert", $"Viewing order #{orderId} details");
    }

    private void ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        LoadOrders();
    }

    private void ClearFilters()
    {
        selectedStatusFilter = "";
        startDate = DateTime.Today.AddDays(-30);
        endDate = DateTime.Today;
        currentPage = 1;
        LoadOrders();
    }

    private string GetStatusBadgeClass(string status)
    {
        return status.ToLower() switch
        {
            "completed" => "badge-success",
            "processing" => "badge-warning",
            "pending" => "badge-info",
            "cancelled" => "badge-error",
            _ => "badge-neutral"
        };
    }

    // API Response wrapper
    public class PagedResponse<T>
    {
        public List<T> Items { get; set; } = new();
        public int PageNumber { get; set; }
        public int PageSize { get; set; }
        public int TotalItems { get; set; }
        public int TotalPages { get; set; }
        public bool HasPreviousPage { get; set; }
        public bool HasNextPage { get; set; }
    }
}