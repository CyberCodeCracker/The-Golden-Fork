@page "/admin/order-history"
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject IJSRuntime JS
@using golden_fork.Front.DTOs.Order
@using golden_fork.Front.DTOs.Purchase
@using golden_fork.core.Enums

<PageTitle>Order History • Golden Fork</PageTitle>

<div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-orange-600 mb-8">Order History</h1>
    
    <!-- Filters -->
    <div class="flex flex-wrap gap-4 mb-6">
        <select class="select select-bordered" @bind="selectedStatusFilter">
            <option value="">All Statuses</option>
            <option value="Pending">Pending</option>
            <option value="Preparing">Preparing</option>
            <option value="Confirmed">Confirmed</option>
            <option value="Ready">Ready</option>
            <option value="Delivered">Delivered</option>
            <option value="Paid">Paid</option>
            <option value="Cancelled">Cancelled</option>
        </select>
        
        <input type="date" class="input input-bordered" @bind="startDate" />
        <input type="date" class="input input-bordered" @bind="endDate" />
        
        <button @onclick="LoadOrders" class="btn btn-primary">Apply Filters</button>
        <button @onclick="ClearFilters" class="btn btn-ghost">Clear</button>
    </div>
    
    @if (isLoading)
    {
        <div class="flex justify-center py-20">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    }
    else if (orders == null || !orders.Any())
    {
        <div class="text-center py-20">
            <p class="text-2xl text-gray-500">No orders found</p>
            <p class="text-gray-500 mt-2">Try adjusting your filters or check if orders exist in the system.</p>
        </div>
    }
    else
    {
        <div class="bg-base-100 p-4 rounded-lg mb-4">
            <p class="text-lg">
                Showing <span class="font-bold">@orders.Count</span> orders 
                (Page @currentPage of @totalPages)
            </p>
        </div>
        
        <div class="space-y-6">
            @foreach (var order in orders)
            {
                <div class="card bg-base-100 shadow-lg">
                    <div class="card-body">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="card-title">Order #@order.Id</h2>
                                <p class="text-gray-600">
                                    Customer: <strong>@order.UserName</strong>
                                </p>
                                <p class="text-gray-600">
                                    Date: @order.OrderDate.ToString("f")
                                </p>
                                <p class="text-gray-600">
                                    Items: @order.ItemCount
                                </p>
                                @if (order.Payment != null)
                                {
                                    <p class="text-gray-600">
                                        Payment: 
                                        <span class="badge @GetPaymentStatusBadgeClass(order.Payment.Status)">
                                            @order.Payment.Status
                                        </span>
                                        (@order.Payment.Method)
                                    </p>
                                }
                            </div>
                            
                            <div class="text-right">
                                <div class="text-2xl font-bold text-primary">
                                    @order.TotalPrice.ToString("C")
                                </div>
                                <div class="mt-2">
                                    <select class="select select-bordered select-sm" 
                                            value="@GetSelectedStatus(order.Id)"
                                            @onchange="@((ChangeEventArgs e) => OnStatusChange(order.Id, e.Value?.ToString()))">
                                        <option value="">Change Status</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Confirmed">Confirmed</option>
                                        <option value="Preparing">Preparing</option>  <!-- Changed from Processing -->
                                        <option value="Ready">Ready</option>
                                        <option value="Delivered">Delivered</option>  <!-- Changed from Completed -->
                                        <option value="Cancelled">Cancelled</option>
                                        <option value="Paid">Paid</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Order Items -->
                        <div class="mt-4">
                            <h3 class="font-semibold mb-2">Order Items:</h3>
                            <div class="overflow-x-auto">
                                <table class="table table-zebra w-full">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in order.Items)
                                        {
                                            <tr>
                                                <td>@item.ItemName</td>
                                                <td>@item.Quantity</td>
                                                <td>@item.UnitPrice.ToString("C")</td>
                                                <td>@item.LineTotal.ToString("C")</td>
                                            </tr>
                                        }
                                    </tbody>
                                    <tfoot>
                                        <tr class="font-bold">
                                            <td colspan="3" class="text-right">Total:</td>
                                            <td>@order.TotalPrice.ToString("C")</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Status and Actions -->
                        <div class="flex justify-between items-center mt-4 pt-4 border-t">
                            <div>
                                <span class="font-semibold">Current Status:</span>
                                <span class="badge @GetStatusBadgeClass(order.Status.ToString()) ml-2">
                                    @order.Status
                                </span>
                                @if (order.UpdatedAt.HasValue)
                                {
                                    <p class="text-sm text-gray-500 mt-1">
                                        Last updated: @order.UpdatedAt.Value.ToString("g")
                                    </p>
                                }
                            </div>
                            
                            <div class="flex gap-2">
                                @{
                                    var selectedStatus = GetSelectedStatus(order.Id);
                                }
                                @if (!string.IsNullOrEmpty(selectedStatus) && 
                                     selectedStatus != order.Status.ToString())
                                {
                                    <button @onclick="() => UpdateOrderStatus(order.Id, selectedStatus)" 
                                            class="btn btn-primary btn-sm">
                                        Update Status
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <div class="flex justify-center mt-8 gap-2">
                <button @onclick="() => ChangePage(currentPage - 1)"
                        disabled="@(currentPage == 1)"
                        class="btn btn-outline">
                    Previous
                </button>
                
                @for (int i = 1; i <= totalPages; i++)
                {
                    <button @onclick="() => ChangePage(i)"
                            class="btn @(i == currentPage ? "btn-primary" : "btn-outline")">
                        @i
                    </button>
                }
                
                <button @onclick="() => ChangePage(currentPage + 1)"
                        disabled="@(currentPage == totalPages)"
                        class="btn btn-outline">
                    Next
                </button>
            </div>
        }
    }
</div>

@code {
    private List<OrderResponse> orders = new();
    private bool isLoading = true;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private string selectedStatusFilter = "";
    private DateTime? startDate = DateTime.Today.AddDays(-30);
    private DateTime? endDate = DateTime.Today;
    
    // For status updates - track status for each order separately
    private Dictionary<int, string> orderStatusSelections = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var url = $"api/order/admin?page={currentPage}&pageSize={pageSize}";
            
            if (!string.IsNullOrEmpty(selectedStatusFilter))
                url += $"&status={selectedStatusFilter}";
            
            if (startDate.HasValue)
                url += $"&startDate={startDate.Value:yyyy-MM-dd}";
            
            if (endDate.HasValue)
                url += $"&endDate={endDate.Value:yyyy-MM-dd}";

            var response = await Http.GetAsync(url);
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                
                var result = System.Text.Json.JsonSerializer.Deserialize<PagedResponse<OrderResponse>>(
                    content, 
                    new System.Text.Json.JsonSerializerOptions 
                    { 
                        PropertyNameCaseInsensitive = true 
                    });
                
                if (result != null)
                {
                    orders = result.Items ?? new List<OrderResponse>();
                    totalPages = result.TotalPages;
                    
                    // Initialize status selections for each order
                    foreach (var order in orders)
                    {
                        if (!orderStatusSelections.ContainsKey(order.Id))
                        {
                            orderStatusSelections[order.Id] = order.Status.ToString();
                        }
                    }
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"API Error: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in LoadOrders: {ex.Message}");
        }

        isLoading = false;
        StateHasChanged();
    }

    private string GetSelectedStatus(int orderId)
    {
        return orderStatusSelections.ContainsKey(orderId) 
            ? orderStatusSelections[orderId] 
            : "";
    }
private async Task UpdateOrderStatus(int orderId, string newStatusString)
{
    Console.WriteLine($"DEBUG: UpdateOrderStatus called for order {orderId} with status {newStatusString}");
    
    try
    {
        // Parse the string to OrderStatus enum (case-insensitive)
        if (Enum.TryParse<OrderStatus>(newStatusString, true, out var newStatus))
        {
            Console.WriteLine($"DEBUG: Parsed '{newStatusString}' to {newStatus} ({(int)newStatus})");
            
            // Use the simpler endpoint: api/order/{id}/status
            var endpoint = $"api/order/{orderId}/status";
            
            // Create the request with Status property
            var updateRequest = new OrderUpdateRequest { Status = newStatus };
            
            Console.WriteLine($"DEBUG: Sending PUT to {endpoint}");
            Console.WriteLine($"DEBUG: Request body: {{ Status: {newStatus} }}");
            
            var response = await Http.PutAsJsonAsync(endpoint, updateRequest);
            
            Console.WriteLine($"DEBUG: Response status: {response.StatusCode}");
            
            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine($"DEBUG: Success! Updating local state...");
                
                // Update the local order status
                var order = orders.FirstOrDefault(o => o.Id == orderId);
                if (order != null)
                {
                    order.Status = newStatus;
                    order.UpdatedAt = DateTime.Now;
                }
                
                // Update the selection for this order
                orderStatusSelections[orderId] = newStatusString;
                
                StateHasChanged();
                Console.WriteLine($"DEBUG: UI refreshed");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"DEBUG: Update failed: {error}");
                
                // If this fails, fall back to the other endpoint
                await TryAlternativeEndpoint(orderId, newStatus, newStatusString);
            }
        }
        else
        {
            Console.WriteLine($"DEBUG: Failed to parse '{newStatusString}' as OrderStatus");
            Console.WriteLine($"DEBUG: Valid values are: {string.Join(", ", Enum.GetNames(typeof(OrderStatus)))}");
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"DEBUG: Exception: {ex.Message}");
    }
}

private async Task TryAlternativeEndpoint(int orderId, OrderStatus newStatus, string newStatusString)
{
    try
    {
        Console.WriteLine($"DEBUG: Trying alternative endpoint: api/order/update-status");
        
        // Fall back to the other endpoint if needed
        var altRequest = new { OrderId = orderId, NewStatus = newStatus };
        var response = await Http.PutAsJsonAsync("api/order/update-status", altRequest);
        
        Console.WriteLine($"DEBUG: Alternative response: {response.StatusCode}");
        
        if (response.IsSuccessStatusCode)
        {
            Console.WriteLine($"DEBUG: Success with alternative endpoint!");
            
            // Update the local order status
            var order = orders.FirstOrDefault(o => o.Id == orderId);
            if (order != null)
            {
                order.Status = newStatus;
                order.UpdatedAt = DateTime.Now;
            }
            
            // Update the selection for this order
            orderStatusSelections[orderId] = newStatusString;
            
            StateHasChanged();
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            Console.WriteLine($"DEBUG: Alternative endpoint also failed: {error}");
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"DEBUG: Exception with alternative endpoint: {ex.Message}");
    }
}
private void OnStatusChange(int orderId, string newStatus)
    {
        if (orderStatusSelections.ContainsKey(orderId))
        {
            orderStatusSelections[orderId] = newStatus ?? "";
        }
        else
        {
            orderStatusSelections.Add(orderId, newStatus ?? "");
        }
        StateHasChanged();
    }

    private void ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        LoadOrders();
    }

    private void ClearFilters()
    {
        selectedStatusFilter = "";
        startDate = DateTime.Today.AddDays(-30);
        endDate = DateTime.Today;
        currentPage = 1;
        LoadOrders();
    }

    private string GetStatusBadgeClass(string status)
    {
        return status.ToLower() switch
        {
            "completed" => "badge-success",
            "processing" => "badge-warning",
            "pending" => "badge-info",
            "cancelled" => "badge-error",
            _ => "badge-neutral"
        };
    }

    private string GetPaymentStatusBadgeClass(string status)
    {
        return status.ToLower() switch
        {
            "paid" => "badge-success",
            "pending" => "badge-warning",
            "failed" => "badge-error",
            _ => "badge-neutral"
        };
    }

    // API Response wrapper
    public class PagedResponse<T>
    {
        public List<T> Items { get; set; } = new();
        public int PageNumber { get; set; }
        public int PageSize { get; set; }
        public int TotalItems { get; set; }
        public int TotalPages { get; set; }
        public bool HasPreviousPage { get; set; }
        public bool HasNextPage { get; set; }
    }
}