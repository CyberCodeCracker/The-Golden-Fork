@page "/categories"
@attribute [Authorize]
@using System.Security.Claims
@using System.Text.Json
@using golden_fork.Front.DTOs.Kitchen
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Categories • Golden Fork</PageTitle>

<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-bold text-orange-600">Categories</h1>

        @if (IsAdminOrChef)
        {
            <button @onclick="OpenAddCategoryModal" class="btn btn-success">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add New Category
            </button>
        }
    </div>

    @if (isLoading)
    {
        <div class="flex justify-center py-20">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
    }
    else if (pagedResult == null || !pagedResult.Items.Any())
    {
        <div class="text-center py-20">
            <p class="text-2xl text-gray-500">No categories found</p>
        </div>
    }
    else
    {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
            @foreach (var category in pagedResult.Items)
            {
                <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all relative">
                    <figure class="h-48 overflow-hidden">
                        @if (!string.IsNullOrEmpty(category.ImageUrl))
                        {
                            <img src="@category.ImageUrl" alt="@category.Name" class="w-full h-full object-cover" />
                        }
                        else
                        {
                            <div class="bg-gradient-to-br from-orange-400 to-amber-600 flex items-center justify-center">
                                <span class="text-5xl font-bold text-white opacity-80">@category.Name.Substring(0, 1).ToUpper()</span>
                            </div>
                        }
                    </figure>
                    <div class="card-body items-center text-center">
                        <h2 class="card-title text-2xl">@category.Name</h2>

                        @if (!string.IsNullOrEmpty(category.Description))
                        {
                            <p class="text-gray-600 mt-2">@category.Description</p>
                        }

                        <p class="text-lg mt-4">@category.ItemCount item@(category.ItemCount == 1 ? "" : "s")</p>

                        <div class="card-actions mt-6">
                            <button @onclick="() => NavigateToCategoryDetails(category.Id)" class="btn btn-info">
                                View Details
                            </button>
                        </div>

                        <!-- Admin/Chef: Delete button -->
                        @if (IsAdminOrChef)
                        {
                            <div class="absolute top-2 right-2">
                                <button @onclick="() => DeleteCategory(category.Id)" class="btn btn-ghost btn-circle text-red-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (pagedResult.TotalPages > 1)
        {
            <div class="flex justify-center mt-12 gap-2">
                <button @onclick="() => ChangePage(pagedResult.PageNumber - 1)"
                        disabled="@(pagedResult.PageNumber == 1)"
                        class="btn btn-outline">
                    Previous
                </button>

                <span class="flex items-center px-4">
                    Page @pagedResult.PageNumber of @pagedResult.TotalPages
                </span>

                <button @onclick="() => ChangePage(pagedResult.PageNumber + 1)"
                        disabled="@(pagedResult.PageNumber == pagedResult.TotalPages)"
                        class="btn btn-outline">
                    Next
                </button>
            </div>
        }
    }
</div>

<!-- Add New Category Modal -->
<!-- Add New Category Modal -->
@if (showAddCategoryModal)
{
    <div class="modal modal-open">
        <div class="modal-box w-11/12 max-w-2xl">
            <h3 class="font-bold text-2xl mb-6">Add New Category</h3>

            <EditForm Model="newCategory" OnValidSubmit="HandleAddCategory">
                <DataAnnotationsValidator />

                @if (!string.IsNullOrEmpty(modalMessage))
                {
                    <div class="alert @(modalSuccess ? "alert-success" : "alert-error") mb-4">
                        <span>@modalMessage</span>
                    </div>
                }

                <div class="space-y-4">
                    <div>
                        <label class="label"><span class="label-text">Name *</span></label>
                        <InputText @bind-Value="newCategory.Name" class="input input-bordered w-full" />
                        <ValidationMessage For="() => newCategory.Name" />
                    </div>

                    <div>
                        <label class="label"><span class="label-text">Description</span></label>
                        <InputTextArea @bind-Value="newCategory.Description" class="textarea textarea-bordered w-full" rows="4" />
                    </div>

                    <div>
                        <label class="label"><span class="label-text">Category Photo</span></label>
                        <InputFile OnChange="OnFileChange" class="file-input file-input-bordered w-full" />
                    </div>
                </div>

                <div class="modal-action mt-6">
                    <button type="submit" class="btn btn-primary" disabled="@modalLoading">
                        @if (modalLoading)
                        {
                            <span class="loading loading-spinner"></span>
                        }
                        Add Category
                    </button>
                    <button type="button" @onclick="CloseAddCategoryModal" class="btn">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
}
@code {
    private PagedResult<CategoryResponse>? pagedResult;
    private bool isLoading = true;
    private bool IsAdminOrChef = false;

    // Add Category Modal
    private bool showAddCategoryModal = false;
    private CategoryRequest newCategory = new();
    private string modalMessage = "";
    private bool modalSuccess = false;
    private bool modalLoading = false;

    private int currentPage = 1;
    private const int PageSize = 12;

    private IBrowserFile? selectedFile;

    private void OnFileChange(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
    }


    protected override async Task OnInitializedAsync()
    {
        await CheckRole();
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        isLoading = true;
        try
        {
            var url = $"api/category?pageNumber={currentPage}&pageSize={PageSize}";
            pagedResult = await Http.GetFromJsonAsync<PagedResult<CategoryResponse>>(url);
        }
        catch
        {
            pagedResult = new PagedResult<CategoryResponse>();
        }
        isLoading = false;
    }

    private async Task CheckRole()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var role = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value;
        IsAdminOrChef = role == "Admin" || role == "Chef";
    }

    private async Task ChangePage(int page)
    {
        if (page < 1 || page > (pagedResult?.TotalPages ?? 1)) return;
        currentPage = page;
        await LoadCategories();
    }

    private void OpenAddCategoryModal()
    {
        newCategory = new CategoryRequest();
        modalMessage = "";
        showAddCategoryModal = true;
    }

    private void CloseAddCategoryModal()
    {
        showAddCategoryModal = false;
    }

    private async Task HandleAddCategory()
    {
        modalLoading = true;
        modalMessage = "";

        try
        {
            var response = await Http.PostAsJsonAsync("api/category", newCategory);

            if (response.IsSuccessStatusCode)
            {
                // Read the response to get categoryId
                var jsonElement = await response.Content.ReadFromJsonAsync<JsonElement>();

                int categoryId = 0;
                if (jsonElement.TryGetProperty("categoryId", out var idProp))
                {
                    categoryId = idProp.GetInt32();
                }
                else if (jsonElement.TryGetProperty("id", out idProp))
                {
                    categoryId = idProp.GetInt32();
                }

                // Upload photo if selected and we have ID
                if (selectedFile != null && categoryId > 0)
                {
                    var content = new MultipartFormDataContent();
                    content.Add(new StreamContent(selectedFile.OpenReadStream(5 * 1024 * 1024)), "photo", selectedFile.Name);

                    var uploadResponse = await Http.PostAsync($"api/category/{categoryId}/upload-photo", content);

                    if (!uploadResponse.IsSuccessStatusCode)
                    {
                        var uploadError = await uploadResponse.Content.ReadAsStringAsync();
                        Console.WriteLine("Photo upload failed: " + uploadError);
                        modalMessage = "Category added, but photo upload failed: " + uploadError;
                    }
                }

                modalSuccess = true;
                modalMessage = "Category added successfully!";
                await Task.Delay(1500);
                CloseAddCategoryModal();
                await LoadCategories();  // Reload to show new category with photo
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                modalSuccess = false;
                modalMessage = "Failed to add category: " + error;
            }
        }
        catch (Exception ex)
        {
            modalSuccess = false;
            modalMessage = "Error: " + ex.Message;
        }

        modalLoading = false;
    }

    private async Task DeleteCategory(int categoryId)
    {
        var confirm = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this category? This will not delete items.");
        if (!confirm) return;

        var response = await Http.DeleteAsync($"api/category/{categoryId}");

        if (response.IsSuccessStatusCode)
        {
            await LoadCategories();
        }
    }

    private void NavigateToCategoryDetails(int categoryId)
    {
        Navigation.NavigateTo($"/category/{categoryId}");
    }
}