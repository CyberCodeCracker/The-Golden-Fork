@page "/orders/history"
@using System.Net.Http.Json
@using golden_fork.Front.Enums
@inject HttpClient Http
@inject NavigationManager Navigation

<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">My Orders</h1>
            <a href="/items" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Continue Shopping
            </a>
        </div>

        @if (isLoading)
        {
            <div class="text-center py-12">
                <span class="loading loading-spinner loading-lg"></span>
                <p class="mt-4">Loading your orders...</p>
            </div>
        }
        else if (!orders.Any())
        {
            <div class="alert alert-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 h-6 w-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>You have no orders yet. <a href="/items" class="link link-primary">Start shopping!</a></span>
            </div>
        }
        else
        {
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in orders)
                        {
                            <tr>
                                <td class="font-bold">#@order.Id</td>
                                <td>@order.OrderDate.ToString("MMM dd, yyyy HH:mm")</td>
                                <td>
                                    <div class="text-sm">
                                        @foreach (var item in order.OrderItems)
                                        {
                                            <div>@item.Item.Name x @item.Quantity</div>
                                        }
                                    </div>
                                </td>
                                <td class="font-bold">@order.TotalAmount.ToString("C")</td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(order.Status)">
                                        @order.Status.ToFriendlyString()
                                    </span>
                                </td>
                                <td>
                                    @if (order.Payment != null)
                                    {
                                        <span class="badge @(order.Payment.IsPaid ? "badge-success" : "badge-warning")">
                                            @(order.Payment.IsPaid ? "Paid" : "Pending")
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-error">No Payment</span>
                                    }
                                </td>
                                <td>
                                    <div class="flex space-x-2">
                                        @if (order.Status == OrderStatus.Pending || order.Status == OrderStatus.Confirmed)
                                        {
                                            <button @onclick="() => CancelOrder(order.Id)" 
                                                    class="btn btn-xs btn-error"
                                                    disabled="@(isCancellingOrderId == order.Id)">
                                                @if (isCancellingOrderId == order.Id)
                                                {
                                                    <span class="loading loading-spinner loading-xs"></span>
                                                }
                                                Cancel
                                            </button>
                                        }
                                        
                                        @if (order.Status == OrderStatus.Ready)
                                        {
                                            <button @onclick="() => MarkAsDelivered(order.Id)" 
                                                    class="btn btn-xs btn-success">
                                                Mark Delivered
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            @if (totalPages > 1)
            {
                <div class="join mt-8">
                    <button class="join-item btn" @onclick="() => ChangePage(currentPage - 1)" 
                            disabled="@(currentPage <= 1)">«</button>
                    
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        <button class="join-item btn @(currentPage == i ? "btn-active" : "")" 
                                @onclick="() => ChangePage(i)">@i</button>
                    }
                    
                    <button class="join-item btn" @onclick="() => ChangePage(currentPage + 1)" 
                            disabled="@(currentPage >= totalPages)">»</button>
                </div>
            }
        }
    </div>
</div>

@code {
    private List<OrderResponse> orders = new();
    private bool isLoading = true;
    private int? isCancellingOrderId = null;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        isLoading = true;
        try
        {
            var response = await Http.GetFromJsonAsync<PagedResult<OrderResponse>>(
                $"api/order?pageNumber={currentPage}&pageSize={pageSize}");
            
            if (response != null)
            {
                orders = response.Items.ToList();
                totalPages = response.TotalPages;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading orders: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CancelOrder(int orderId)
    {
        isCancellingOrderId = orderId;
        
        try
        {
            var response = await Http.PostAsync($"api/order/{orderId}/cancel", null);
            
            if (response.IsSuccessStatusCode)
            {
                // Reload orders
                await LoadOrders();
            }
        }
        finally
        {
            isCancellingOrderId = null;
        }
    }

    private async Task MarkAsDelivered(int orderId)
    {
        // You might want to create an endpoint for this
        // For now, just update locally
        var order = orders.FirstOrDefault(o => o.Id == orderId);
        if (order != null)
        {
            order.Status = OrderStatus.Delivered;
            StateHasChanged();
        }
    }

    private async Task ChangePage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            await LoadOrders();
        }
    }

    private string GetStatusBadgeClass(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Pending => "badge-warning",
            OrderStatus.Confirmed => "badge-info",
            OrderStatus.Preparing => "badge-primary",
            OrderStatus.Ready => "badge-success",
            OrderStatus.Delivered => "badge-success",
            OrderStatus.Cancelled => "badge-error",
            OrderStatus.Paid => "badge-success",
            _ => "badge"
        };
    }

    // DTOs
    private class PagedResult<T>
    {
        public List<T> Items { get; set; } = new();
        public int TotalCount { get; set; }
        public int PageNumber { get; set; }
        public int PageSize { get; set; }
        public int TotalPages => (int)Math.Ceiling(TotalCount / (double)PageSize);
    }

    private class OrderResponse
    {
        public int Id { get; set; }
        public DateTime OrderDate { get; set; }
        public OrderStatus Status { get; set; }
        public decimal TotalAmount { get; set; }
        public List<OrderItemResponse> OrderItems { get; set; } = new();
        public PaymentResponse? Payment { get; set; }
    }

    private class OrderItemResponse
    {
        public int Id { get; set; }
        public int Quantity { get; set; }
        public ItemResponse Item { get; set; } = null!;
    }

    private class ItemResponse
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public decimal Price { get; set; }
    }

    private class PaymentResponse
    {
        public bool IsPaid { get; set; }
        public DateTime? PaymentDate { get; set; }
    }
}